<!doctype html>
<head>
  <meta charset="utf-8">
  <title>cssobj playground</title>
  <!--[if lte IE 8]>
  <script type="text/javascript" src="http://1111hui.com/js/es5-shim.min.js"></script>
  <script type="text/javascript" src="http://1111hui.com/js/json3.min.js"></script>
  <![endif]-->

    <script type="text/javascript" src="../../cssobj-core/dist/cssobj-core.iife.js"></script>
    <script type="text/javascript" src="../../cssobj-plugin-default-unit/dist/cssobj-plugin-default-unit.iife.js"></script>
    <script type="text/javascript" src="../../cssobj-plugin-gencss/dist/cssobj-plugin-gencss.iife.js"></script>
    <script type="text/javascript" src="../../cssobj-plugin-cssom/dist/cssobj-plugin-cssom.iife.js"></script>
    <script type="text/javascript" src="../../cssobj-core/play/pagecss.js"></script>
    <script type="text/javascript">
  var css = cssobj_core(
    {
      local:false,
      plugins:[
          cssobj_plugin_default_unit('px'),
          cssobj_plugin_cssom()
      ]
    }
  )(pagecss)

var windowWidth = function(){return document.documentElement.offsetWidth-4}
var windowHeight = function(){return document.documentElement.offsetHeight}

var refh3 = css.ref.h3
var refLeft = css.ref.left.obj
var refRight = css.ref.right.obj
var reftextarea = css.ref.textarea.obj
// for page css
function h3Height() {
  var h3Val = refh3.rawVal
  return h3Val.fontSize * h3Val.lineHeight + h3Val.marginTop + h3Val.marginBottom
}

reftextarea.height=function(last, node, result) {
  var w = windowWidth()
  var h = windowHeight()
  return w<900? h/2 - h3Height() : h-h3Height()
}

refh3.obj.left = function(){ return 10}
refh3.obj.color = function() {
  var w = windowWidth()
  return w<900? 'blue' : 'green'
}
delete reftextarea.color
delete pagecss.table

refRight.width = refLeft.width = function(last, node, result) {
  var w = windowWidth()
  return w<900? w : w/2
}
refh3.obj.fontSize = function(last, node, result) {
  return result.data.resize ? parseInt(last) : parseInt(last)+1
}
css.ref.ff.obj.textarea = {
  color: 'red'
}
pagecss.div = {
  color: 'red'
}
window.onresize = function(){
  css.update({resize:true})
}
// console.log(css)

                </script>
</head>
<body>
  <div class="left div">
    <h3 title="a,b">JS Object: (paste/change below)</h3>
    <textarea id="src" oninput="convert(this)">
      {
      p: {display:'flex', color:'red'}
}    </textarea>
  </div>
  <div class="right div">
    <h3 id="h3">CSS Text: (paste/change below)
      <label><input type="radio" name="format" value="css" checked onclick="parse()">CSS</label>
      <!-- <label><input type="radio" name="format" value="scss" onclick="parse()">SCSS</label> -->
      <label><input type="radio" name="format" value="less" onclick="parse()">LESS</label></h3>
    <textarea id="css" oninput="parse()"></textarea>
  </div>
  <script type="text/javascript">

function $(sel) {
  return document.getElementById(sel)
}
var src = $('src')
function cssobj_plugin_replace (option) {
  option = option || {}

  var replaceMap = option.maps || [
    [
      'display',
      'flex',
      [
        {
          display: '-webkit-box'
        }, {
          display: '-moz-box'
        }, {
          display: '-ms-flexbox',
          '-ms-flex-preferred-size': 'initial' // IE10
        }, {
          display: '-webkit-flex'
        }, {
          display: 'flex'
        }
      ]
    ],
    [
      'display',
      'inline-flex',
      [
        {
          display: '-ms-inline-flexbox'
        }, {
          display: '-webkit-inline-flex'
        }, {
          display: 'inline-flex'
        }
      ]
    ],
    [
      'flex-direction',
      'row',
      {
        '-ms-flex-direction': 'row',
        '-webkit-flex-direction': 'row',
        'flex-direction': 'row'
      }
    ],
    [null,null, function(key, value){return key=='color'? {[key]:value, zoom:1} : {}}]
  ]

  return {
    value: function (value, key, node, result, propKey) {

      if(propKey!==undefined) return value

      // retVal hold all maps result
      var retVal = []

      // replace from prop+value, to mapped value
      for(var map, val, i = 0, len = replaceMap.length; i < len; i++) {

        map = replaceMap[i]
        val = map[2]

        // map[0] : prop, null as placeholder
        // map[1] : value, null as placeholder
        // map[2] : replacement, function(key, value){} || any
        if((map[0]===null || map[0]==key)
           && (map[1]===null || map[1]==value))

          retVal.push(
            typeof val=='function'
              ? val(key, value, node, result)
              : val
          )
      }

      // only accept replaced value, return original value as fallback
      return retVal.length ? retVal : value
    }
  }
}
var opt = {local:1, propSugar:1, plugins: [
  cssobj_plugin_gencss({indent:'  '}),
  cssobj_plugin_replace()
], localNames:{p:'_prefix_p'}}

var cssobjFunc = cssobj_core(opt)

var testObj, ret
function convert(el) {
  try{
    var func = new Function('return '+el.value)
    testObj = func()
    ret = cssobjFunc(testObj)
    $('css').value = ret.css
    // console.log(ret)

  }catch(e){
    // console.log(e)
  }
}
convert(src)

var serverURL = window.location.hostname.match(/rhcloud/i) ? '/converter' : 'http://1111hui.com:8080'

function parse() {
  var el = $('css')
  var value = el.value

  // server using cssobj-converter project: npm run server
  fetch(serverURL, {method:'POST', body:JSON.stringify({text:value, format: getFormat()})})
    .then(function(v) {
      if(v.ok)
        v.text().then(function(text){ src.value = text})
    })
}

function getFormat() {
  var el = document.getElementsByName('format')
  for(var i = 0, len = el.length; i < len; i++) {
    if(el[i].checked) return el[i].value
  }
}


h3.onclick=function() {
  // css.update(null)
}

window.onresize()

  </script>
</body>
